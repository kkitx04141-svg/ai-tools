<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI 生图工具</title>
  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e5e7eb;
      --shadow: 0 18px 60px rgba(15, 23, 42, 0.08);
      --radius: 14px;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --danger: #dc2626;
      --ok: #16a34a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 42px 16px 60px;
    }
    .hero{
      text-align:center;
      margin-bottom: 18px;
    }
    .hero h1{
      margin:0 0 10px;
      font-size: 36px;
      letter-spacing: .3px;
    }
    .hero p{
      margin:0;
      color: var(--muted);
      line-height: 1.6;
      font-size: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 26px;
      margin: 24px auto 0;
    }

    .section-title{
      font-weight: 700;
      font-size: 16px;
      margin: 0 0 14px;
    }

    label{
      display:block;
      font-size: 13px;
      font-weight: 600;
      margin: 14px 0 8px;
    }
    .subhint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.55;
    }

    textarea, input, select{
      width: 100%;
      padding: 12px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      outline: none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    textarea{ min-height: 110px; resize: vertical; }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(79,70,229,.55);
      box-shadow: 0 0 0 4px rgba(79,70,229,.12);
    }

    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }
    @media (max-width: 860px){
      .grid3{ grid-template-columns: 1fr; }
      .hero h1{ font-size: 30px; }
    }

    .actions{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    .btn{
      border: 0;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: transform .06s ease, background .12s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: var(--primary);
      color: #fff;
    }
    .btn-primary:hover{ background: var(--primary-hover); }
    .btn-secondary{
      background: #eef2ff;
      color: #3730a3;
    }
    .btn-secondary:hover{ background: #e0e7ff; }

    .status{
      flex: 1;
      min-width: 240px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #f8fafc;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .status.ok{ border-color: rgba(22,163,74,.25); color: #166534; background: rgba(22,163,74,.06); }
    .status.err{ border-color: rgba(220,38,38,.25); color: #7f1d1d; background: rgba(220,38,38,.06); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }

    .preview{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .preview img{
      width:100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #f1f5f9;
    }
    @media (max-width: 860px){
      .preview{ grid-template-columns: repeat(4, 1fr); }
    }
    @media (max-width: 520px){
      .preview{ grid-template-columns: repeat(3, 1fr); }
    }

    .results{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 14px;
    }
    .results img{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #f1f5f9;
    }
    @media (max-width: 860px){
      .results{ grid-template-columns: 1fr; }
    }

    .divider{
      height:1px;
      background: var(--line);
      margin: 18px 0;
    }

    code{
      padding: 2px 6px;
      border-radius: 8px;
      background: #f1f5f9;
      border: 1px solid var(--line);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>AI 生图工具</h1>
      <p>
        支持文生图 / 图生图，用于电商设计、方案探索与视觉创作。上传参考图可增强一致性，不上传即为纯文本生成。<br/>
        <span class="mono">Stage 1：</span>前端只提交与展示，调试以 n8n Execution 为准。
      </p>
    </div>

    <div class="card">
      <div class="section-title">提示词</div>
      <textarea id="prompt" placeholder="例如：现代极简风格的办公椅，白色背景，商业产品摄影，干净柔光"></textarea>

      <div class="divider"></div>

      <div class="section-title">参考图片（可选）</div>
      <input id="refImages" type="file" accept="image/*" multiple />
      <div class="subhint">最多上传 10 张。不上传即为文生图。</div>
      <div id="preview" class="preview"></div>

      <div class="divider"></div>

      <div class="section-title">生成设置</div>
      <div class="grid3">
        <div>
          <label for="aspect">画面比例</label>
          <select id="aspect">
            <option value="1:1">1:1（方形）</option>
            <option value="16:9">16:9（横版）</option>
            <option value="9:16">9:16（竖版）</option>
            <option value="4:3">4:3</option>
            <option value="3:4">3:4</option>
          </select>
        </div>

        <div>
          <label for="sizePreset">分辨率（Gemini 档位）</label>
          <select id="sizePreset">
            <option value="1K">1K</option>
            <option value="2K" selected>2K</option>
            <option value="4K">4K</option>
          </select>
          <div class="subhint">仅传档位给 n8n，由 n8n 映射到模型参数。</div>
        </div>

        <div>
          <label for="count">生成数量</label>
          <input id="count" type="number" min="1" max="8" value="1" />
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="submitBtn">开始生成</button>
        <button class="btn btn-secondary" id="clearBtn" type="button">清空</button>
        <div id="status" class="status"><span class="mono">Ready.</span></div>
      </div>

      <div class="subhint" style="margin-top:10px;">
        n8n 建议返回：A) <code>{ "images": ["https://.../1.png"] }</code> 或 B) <code>{ "images": [{ "mimeType":"image/png", "dataBase64":"..." }] }</code>
      </div>
    </div>

    <div class="card">
      <div class="section-title">生成结果</div>
      <div id="results" class="results"></div>
      <div class="subhint" style="margin-top:10px;">
        如果网页请求报跨域（CORS），说明 n8n Webhook 需要加响应头：<code>Access-Control-Allow-Origin: *</code>（我们后面在工作流里统一加）。
      </div>
    </div>
  </div>

  <script>
    // ✅ 改这里：换成你的 n8n Webhook URL（webhook-test 或 webhook 都行）
    const WEBHOOK_URL = "https://YOUR_DOMAIN_OR_IP/webhook/YOUR_WEBHOOK_PATH";

    const elPrompt = document.getElementById("prompt");
    const elFiles = document.getElementById("refImages");
    const elPreview = document.getElementById("preview");
    const elResults = document.getElementById("results");
    const elStatus = document.getElementById("status");
    const elSubmit = document.getElementById("submitBtn");
    const elClear = document.getElementById("clearBtn");

    function setStatus(msg, type="") {
      elStatus.className = "status " + (type || "");
      elStatus.innerHTML = `<span class="mono">${msg || ""}</span>`;
    }

    function renderPreview(files) {
      elPreview.innerHTML = "";
      [...files].slice(0,10).forEach(f => {
        const img = document.createElement("img");
        img.alt = f.name;
        img.src = URL.createObjectURL(f);
        elPreview.appendChild(img);
      });
    }

    function clearResults(){ elResults.innerHTML = ""; }

    function appendResult(src){
      const img = document.createElement("img");
      img.src = src;
      img.alt = "result";
      elResults.appendChild(img);
    }

    elFiles.addEventListener("change", () => {
      const files = elFiles.files || [];
      if (files.length > 10) setStatus("参考图超过 10 张，已截断为前 10 张。");
      else setStatus("Ready.");
      renderPreview(files);
    });

    elClear.addEventListener("click", () => {
      elPrompt.value = "";
      elFiles.value = "";
      elPreview.innerHTML = "";
      clearResults();
      setStatus("已清空。");
    });

    async function submit(){
      clearResults();

      const prompt = (elPrompt.value || "").trim();
      if (!prompt) return setStatus("请先填写提示词。", "err");
      if (!WEBHOOK_URL.startsWith("http")) return setStatus("请先配置 WEBHOOK_URL。", "err");

      const aspect = document.getElementById("aspect").value;
      const sizePreset = document.getElementById("sizePreset").value; // 1K/2K/4K
      const count = Number(document.getElementById("count").value || 1);

      const files = [...(elFiles.files || [])].slice(0,10);

      const form = new FormData();
      form.append("prompt", prompt);
      form.append("aspect", aspect);
      form.append("sizePreset", sizePreset);
      form.append("count", String(count));
      form.append("mode", files.length ? "img2img" : "txt2img");
      form.append("refImageCount", String(files.length));
      files.forEach(f => form.append("refImages", f, f.name));

      try{
        elSubmit.disabled = true;
        setStatus("提交中…");

        const res = await fetch(WEBHOOK_URL, { method:"POST", body: form });
        const ct = res.headers.get("content-type") || "";

        if(!res.ok){
          const t = await res.text();
          return setStatus(`请求失败：HTTP ${res.status} ${t.slice(0,220)}`, "err");
        }

        if (ct.includes("application/json")) {
          const data = await res.json();

          if (Array.isArray(data.images) && typeof data.images[0] === "string") {
            data.images.forEach(u => appendResult(u));
            return setStatus(`完成：收到 ${data.images.length} 张图片 URL。`, "ok");
          }

          if (Array.isArray(data.images) && data.images[0] && data.images[0].dataBase64) {
            data.images.forEach(obj => {
              const mime = obj.mimeType || "image/png";
              appendResult(`data:${mime};base64,${obj.dataBase64}`);
            });
            return setStatus(`完成：收到 ${data.images.length} 张 base64 图片。`, "ok");
          }

          console.log("Response JSON:", data);
          return setStatus("请求成功，但返回 JSON 没有可识别的 images 字段。", "err");
        }

        if (ct.startsWith("image/")) {
          const blob = await res.blob();
          appendResult(URL.createObjectURL(blob));
          return setStatus("完成：收到 1 张图片二进制。", "ok");
        }

        const text = await res.text();
        console.log("Response text:", text);
        return setStatus("请求成功，但响应不是 JSON/图片。", "err");
      } catch(e){
        return setStatus(`请求异常：${e.message}`, "err");
      } finally{
        elSubmit.disabled = false;
      }
    }

    elSubmit.addEventListener("click", submit);
    setStatus("Ready.");
  </script>
</body>
</html>
