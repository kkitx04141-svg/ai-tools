<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xiucai AI - 文生图/图生图提交</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; line-height: 1.4; }
    .wrap { max-width: 920px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .hint { color: #555; font-size: 14px; margin-bottom: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    label { display: block; font-size: 14px; margin: 10px 0 6px; }
    textarea, input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 14px; }
    textarea { min-height: 110px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    button { padding: 12px 14px; border: 0; border-radius: 10px; font-size: 14px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #eee; }
    .actions { display: flex; gap: 10px; align-items: center; margin-top: 14px; }
    .status { font-size: 13px; color: #333; }
    .error { color: #b00020; }
    .previews { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; }
    .previews img { width: 100%; height: 110px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; }
    .results { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .results img { width: 100%; border-radius: 12px; border: 1px solid #ddd; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    @media (max-width: 820px) {
      .row, .row3 { grid-template-columns: 1fr; }
      .previews { grid-template-columns: repeat(3, 1fr); }
      .results { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Xiucai AI - 生图提交</h1>
    <div class="hint">
      这是一个“提交器/结果展示页”。前端只负责把 prompt + 参考图等数据发给 n8n Webhook，
      调试以 n8n Execution 为准。<br/>
      你需要在下方把 <code>WEBHOOK_URL</code> 改成你的 n8n Webhook 地址。
    </div>

    <div class="card">
      <label for="prompt">Prompt（必填）</label>
      <textarea id="prompt" placeholder="输入提示词，例如：一只戴墨镜的橘猫，写实摄影风格，柔和光线..."></textarea>

      <label for="refImages">参考图（可选，1–10 张）</label>
      <input id="refImages" type="file" accept="image/*" multiple />
      <div class="hint">选择后会在下方预览。超过 10 张会自动截断。</div>
      <div id="preview" class="previews"></div>

      <div class="row3">
        <div>
          <label for="count">生图数量</label>
          <input id="count" type="number" min="1" max="8" value="1" />
          <div class="hint">建议先 1 张调试，跑通再加。</div>
        </div>
        <div>
          <label for="aspect">比例（Aspect Ratio）</label>
          <select id="aspect">
            <option value="1:1">1:1</option>
            <option value="16:9">16:9</option>
            <option value="9:16">9:16</option>
            <option value="4:3">4:3</option>
            <option value="3:4">3:4</option>
          </select>
        </div>
        <div>
          <label for="mode">模式</label>
          <select id="mode">
            <option value="txt2img">文生图（txt2img）</option>
            <option value="img2img">图生图（img2img）</option>
          </select>
          <div class="hint">有参考图时通常选 img2img。</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="width">宽（px）</label>
          <input id="width" type="number" min="256" step="64" value="1024" />
        </div>
        <div>
          <label for="height">高（px）</label>
          <input id="height" type="number" min="256" step="64" value="1024" />
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="submitBtn">提交到 n8n</button>
        <button class="secondary" id="clearBtn" type="button">清空</button>
        <div id="status" class="status"></div>
      </div>
    </div>

    <div class="card">
      <div class="hint">
        结果展示：支持两种返回格式（你可以让 n8n 任选其一）<br/>
        A) JSON: <code>{ "images": ["https://.../1.png", "https://.../2.png"] }</code><br/>
        B) JSON: <code>{ "images": [{ "mimeType":"image/png", "dataBase64":"..." } ] }</code>
      </div>
      <div id="results" class="results"></div>
    </div>
  </div>

  <script>
    // ✅ 改这里：换成你的 n8n Webhook URL（测试/生产都行）
    // 例: https://xiucai-ai.xyz/webhook/your-path
    const WEBHOOK_URL = "https://YOUR_DOMAIN_OR_IP/webhook/YOUR_WEBHOOK_PATH";

    const elPrompt = document.getElementById("prompt");
    const elFiles = document.getElementById("refImages");
    const elPreview = document.getElementById("preview");
    const elResults = document.getElementById("results");
    const elStatus = document.getElementById("status");
    const elSubmit = document.getElementById("submitBtn");
    const elClear = document.getElementById("clearBtn");

    function setStatus(msg, isError=false) {
      elStatus.textContent = msg || "";
      elStatus.className = "status" + (isError ? " error" : "");
    }

    function clearResults() {
      elResults.innerHTML = "";
    }

    function renderPreview(files) {
      elPreview.innerHTML = "";
      [...files].slice(0, 10).forEach(file => {
        const img = document.createElement("img");
        img.alt = file.name;
        img.src = URL.createObjectURL(file);
        elPreview.appendChild(img);
      });
    }

    elFiles.addEventListener("change", () => {
      const files = elFiles.files || [];
      if (files.length > 10) {
        setStatus("参考图超过 10 张，已按前 10 张处理。");
      } else {
        setStatus("");
      }
      renderPreview(files);
    });

    elClear.addEventListener("click", () => {
      elPrompt.value = "";
      elFiles.value = "";
      elPreview.innerHTML = "";
      clearResults();
      setStatus("已清空。");
    });

    function appendResultImage(src) {
      const img = document.createElement("img");
      img.src = src;
      img.alt = "result";
      elResults.appendChild(img);
    }

    async function submit() {
      clearResults();
      setStatus("");

      const prompt = (elPrompt.value || "").trim();
      if (!prompt) {
        setStatus("请先填写 prompt。", true);
        return;
      }
      if (!WEBHOOK_URL.includes("http")) {
        setStatus("请先在代码里配置 WEBHOOK_URL。", true);
        return;
      }

      const count = Number(document.getElementById("count").value || 1);
      const aspect = document.getElementById("aspect").value;
      const width = Number(document.getElementById("width").value || 1024);
      const height = Number(document.getElementById("height").value || 1024);
      const mode = document.getElementById("mode").value;

      const files = [...(elFiles.files || [])].slice(0, 10);

      // 用 multipart/form-data 发送：prompt + 参数 + 多文件
      const form = new FormData();
      form.append("prompt", prompt);
      form.append("count", String(count));
      form.append("aspect", aspect);
      form.append("width", String(width));
      form.append("height", String(height));
      form.append("mode", mode);
      form.append("refImageCount", String(files.length));
      files.forEach((f, i) => form.append("refImages", f, f.name)); // 同名字段 => 数组

      try {
        elSubmit.disabled = true;
        setStatus("提交中...");

        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          body: form,
          // ⚠️ 如果你的 n8n Webhook 没配 CORS，会在浏览器报跨域
          // 这种情况下，先用 n8n 内部调试通过，再来加响应头
        });

        const contentType = res.headers.get("content-type") || "";
        if (!res.ok) {
          const text = await res.text();
          setStatus(`请求失败：HTTP ${res.status}，${text.slice(0, 300)}`, true);
          return;
        }

        if (contentType.includes("application/json")) {
          const data = await res.json();

          // 兼容 A) {images:[url...]}
          if (Array.isArray(data.images) && typeof data.images[0] === "string") {
            data.images.forEach(u => appendResultImage(u));
            setStatus(`完成：收到 ${data.images.length} 张图片 URL。`);
            return;
          }

          // 兼容 B) {images:[{mimeType,dataBase64}]}
          if (Array.isArray(data.images) && data.images[0] && data.images[0].dataBase64) {
            data.images.forEach(imgObj => {
              const mime = imgObj.mimeType || "image/png";
              appendResultImage(`data:${mime};base64,${imgObj.dataBase64}`);
            });
            setStatus(`完成：收到 ${data.images.length} 张 base64 图片。`);
            return;
          }

          setStatus("请求成功，但返回 JSON 不包含可识别的 images 字段。请检查 n8n 最终响应结构。", true);
          console.log("Response JSON:", data);
          return;
        }

        // 如果你让 n8n 直接返回二进制图片（不推荐第一阶段这样搞）
        if (contentType.startsWith("image/")) {
          const blob = await res.blob();
          appendResultImage(URL.createObjectURL(blob));
          setStatus("完成：收到 1 张图片二进制。");
          return;
        }

        // 其他情况
        const text = await res.text();
        setStatus("请求成功，但响应不是 JSON/图片。请检查 n8n Webhook Response。", true);
        console.log("Response text:", text);
      } catch (e) {
        setStatus(`请求异常：${e.message}`, true);
      } finally {
        elSubmit.disabled = false;
      }
    }

    elSubmit.addEventListener("click", submit);
  </script>
</body>
</html>
